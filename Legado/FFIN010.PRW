#Include "Protheus.ch"#Include "TopConn.ch"/*/ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±±±³Funcao    ³ FFIN010  ³ Autor ³  Amauri Bailon        ³ Data ³ 08.02.14 ³±±±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±±±³Descricao ³                                                            ³±±±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±±±³Alteracoes³                                                            ³±±±±³          ³                                                            ³±±±±³          ³                                                            ³±±±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±±±³ Uso      ³ FTI                                                        ³±±±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/User Function FFIN010()Local aSays     := {}             											//Mensagem do Dialogo PrincipalLocal aButtons  := {}             											//Botoes do dialogo principalLocal cCadastro := "C O N C I L I A C A O   C O N T A S   A   P A G A R"    //Titulo do programaLocal lOk       := .F.    	 		   	 	  	 							//Confirmacao da tela do dialogo principalLocal aRet		:= {}Local aParamBox	:= {}Local aArea		:= GetArea()Private cAlias	:= GetNextAlias()Private cFolder	:= ""Private cLocaPath	:= ""aAdd(aParamBox,{1,"Data de ",CToD("  /  /  "),"","","","",0,.T.})aAdd(aParamBox,{1,"Data ate",CToD("  /  /  "),"","","","",0,.T.})AAdd(aSays,"                                                                       " )AAdd(aSays,"      Este programa tem por objetivo gerar uma tabela com os dados dos " )AAdd(aSays,"      titulos a pagar e contabilidade para conciliacao.                " )AAdd(aButtons, { 5,.T.,{|| ParamBox(aParamBox,"Conciliacao Financeira",@aRet) } } )AAdd(aButtons, { 1,.T.,{|o| lOk := .T.,o:oWnd:End()}} )AAdd(aButtons, { 2,.T.,{|o| o:oWnd:End() }} )FormBatch( cCadastro, aSays, aButtons )If lOk .And. Aviso("Conciliacao", "Confirma a geracao da tabela de conciliacao?", {"Sim","Nao"}) == 2	ReturnEndIf	//cFolder := cGetFile( , 'Selecione a pasta onde sera gerado o arquivo xls',, cLocaPath, .T., GETF_NETWORKDRIVE + GETF_LOCALFLOPPY + GETF_LOCALHARD + GETF_RETDIRECTORY, .F.)//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿//³Caso seja confirmada, realiza a consulta.                  				³//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙIf lOk	MsgRun( "Aguarde, gerando os dados ...",, { || FFIN010Proc() } )EndIfRestArea(aArea)Return Nil////////////////////////////////////////////////////////                                                  //// FFIN010PROC - Processamento da rotina            ////                                                  ////////////////////////////////////////////////////////Static Function FFIN010Proc()Local cQuery := ""local cPath 	     Private cArqTxt //:= "C:\MAPANECESSIDADE.CSV"Private nHdl    //:= fCreate(cArqTxt)Private cEOL    := "CHR(13)+CHR(10)"ProcRegua(12)//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿//| Criacao do arquivo CSV para cada tabela e validacao de abertura do mesmo     |//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙcArqTxt := "\SPOOL\Conciliacao"+Substr(cUsuario,7,4)+"_"+DToS(Date())+StrTran(Time(), ":", "")+".CSV"nHdl    := fCreate(cArqTxt)If nHdl == -1    MsgAlert("O arquivo de nome "+cArqTxt+" nao pode ser executado! Verifique os parametros.","Atencao!")    ReturnEndif// Escreve linha contendo os titulos de cada colunacLin := ''cLin := 'TITULO;TIPO;FORNECEDOR;NOME;EMISSAO;VENCIMENTO;VALOR;NATUREZA;DESCRICAO;CT2_VALOR;CENTRODECUSTO;DESCRICAO;DEBITO;DESCRICAO;CREDITO;DESRICAO'cLin += &(cEOL)If fWrite(nHdl,cLin,Len(cLin)) != Len(cLin)	If !MsgAlert("Ocorreu um erro na gravacao do arquivo de conciliacao. Continua?","Atencao!")		Return()	EndifEndifcQuery := "SELECT E2_NUM, E2_TIPO, E2_FORNECE, A2_NREDUZ, E2_EMISSAO, E2_VENCREA, E2_VALOR, E2_NATUREZ, ED_DESCRIC, "cQuery += "		CT2_VALOR, EZ_CCUSTO, CTT_DESC01, CT2_DEBITO, A.CT1_DESC01 CT1_DESCD, CT2_CREDIT, B.CT1_DESC01 CT1_DESCC "cQuery += "FROM "+RetSQLName("SE2")+" E2 "cQuery += "INNER JOIN "+RetSQLName("SA2")+" A2 ON A2_COD = E2_FORNECE AND A2_LOJA = E2_LOJA AND A2.D_E_L_E_T_ = '' "cQuery += "INNER JOIN "+RetSQLName("SED")+" ED ON ED_FILIAL = '' AND ED_CODIGO = E2_NATUREZ AND ED.D_E_L_E_T_ = '' "cQuery += "LEFT OUTER JOIN "+RetSQLName("SEV")+" EV ON EV_FILIAL = E2_FILIAL AND EV_NUM = E2_NUM AND EV_PREFIXO = E2_PREFIXO "cQuery += "		AND EV_TIPO = E2_TIPO AND EV_PARCELA = E2_PARCELA AND EV_CLIFOR = E2_FORNECE AND EV_LOJA = E2_LOJA "cQuery += "		AND EV.D_E_L_E_T_ = '' "cQuery += "INNER JOIN "+RetSQLName("SEZ")+" EZ ON EZ_FILIAL = EV_FILIAL AND EZ_NUM = EV_NUM AND EZ_PREFIXO = EV_PREFIXO "cQuery += "		AND EZ_TIPO = EV_TIPO AND EZ_PARCELA = EV_PARCELA AND EZ_CLIFOR = EV_CLIFOR AND EZ_LOJA = EV_LOJA "cQuery += "		AND EZ_NATUREZ = EV_NATUREZ AND EZ.D_E_L_E_T_ = '' "cQuery += "INNER JOIN "+RetSQLName("CTT")+" CTT ON CTT_CUSTO = EZ_CCUSTO AND CTT.D_E_L_E_T_ = '' "cQuery += "INNER JOIN "+RetSQLName("CT2")+" CT2 ON CT2_DATA BETWEEN '"+DtoC(mv_par01)+"' AND '"+DtoC(mv_par02)+"' "cQuery += "		AND (CT2_CCD = EZ_CCUSTO OR CT2_CCC = EZ_CCUSTO) AND (CT2_ITEMD = EZ_ITEMCTA OR CT2_ITEMC = EZ_ITEMCTA) "cQuery += "		AND (CT2_CLVLDB = EZ_CLVL OR CT2_CLVLCR = EZ_CLVL) AND CT2_VALOR = EZ_VALOR AND CT2.D_E_L_E_T_ = '' "cQuery += "INNER JOIN "+RetSQLName("CT1")+" A ON A.CT1_CONTA = CT2_DEBITO AND A.D_E_L_E_T_ = '' "cQuery += "INNER JOIN "+RetSQLName("CT1")+" B ON B.CT1_CONTA = CT2_CREDIT AND B.D_E_L_E_T_ = '' "cQuery += "WHERE E2_FILIAL = '"+xFilial("SE2")+"' AND E2_EMISSAO BETWEEN '"+Dtoc(mv_par01)+"' AND '"+DtoC(mv_par02)+"' "cQuery += "		AND E2.D_E_L_E_T_ = '' "cQuery += "ORDER BY E2_EMISSAO, E2_NUM"cQuery := ChangeQuery( cQuery )If Select(cAlias) <> 0	dbSelectArea(cAlias)	dBClosearea()EndIf//TCQUERY cQuery NEW ALIAS cAliasdbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAlias,.T.,.T.)                     dbSelectArea(cAlias)(cAlias)->(dbGoTop())While !(cAlias)->(Eof())	cLin := ''	cLin := alltrim(E2_NUM)+';'+alltrim(E2_TIPO)+';'+alltrim(E2_FORNECE)+';'+alltrim(A2_NREDUZ)+';'+alltrim(DtoC(StoD(E2_EMISSAO)))+';'+alltrim(DtoC(StoD(E2_VENCREA)))+';'+alltrim(Str(E2_VALOR))+';'+alltrim(E2_NATUREZ)+';'+alltrim(ED_DESCRIC)+';'+alltrim(Str(CT2_VALOR))+';'+alltrim(EZ_CCUSTO)+';'+alltrim(CTT_DESC01)+';'+alltrim(CT2_DEBITO)+';'+alltrim(CT1_DESCD)+';'+alltrim(CT2_CREDIT)+';'+alltrim(CT1_DESCC)+';'	cLin += &(cEOL)    If fWrite(nHdl,cLin,Len(cLin)) != Len(cLin)        If !MsgAlert("Ocorreu um erro na gravacao do arquivo de conciliacao. Continua?","Atencao!")            Exit        Endif    Endif	(cAlias)->(dbSkip())EndDofClose(nHdl)/*dbSelectArea(cAlias)//+-------------------------------------------------------------------------------//| Gera arquivo do tipo .DBF com extensao .XLS p/ usuario abrir no Excel.//+-------------------------------------------------------------------------------//cArqExcel := cFolder+"\Conciliacao"+Substr(cUsuario,7,4)+"_"+DToS(Date())+StrTran(Time(), ":", "")+".XLS" cArqExcel := "\SPOOL\Conciliacao"+Substr(cUsuario,7,4)+"_"+DToS(Date())+StrTran(Time(), ":", "")+".XLS"Copy To &cArqExcel VIA "DBFCDXADS"dbCloseArea()*/If Select(cAlias) <> 0	dbSelectArea(cAlias)	dBClosearea()EndIfMsgInfo("Arquivo gerado com sucesso em: "+cArqTxt)Return